---
layout: post
title: "PHP垃圾回收"
description: ""
category: 
tags: [PHP]
---
{% include JB/setup %}

##PHP垃圾回收的故事##

想到这个问题的原因是昨天实例化了两个类，得到了两个Obj，然后就想到他们是怎么消失？文件执行完PHP都对他们做了什么事？内存怎么管理的？他们的世界都发生了什么有趣的事情？


带着这些问题我开始一次有趣的探险。

在PHP5.3以前，回收机制是这样的，有个PHP底层的小家伙叫zval(变量容器)，他做的事情是存储变量的类型(变量类型字符串、整型、数组)、值还有两个附属信息`is_ref(bool)`以及`refcount`。

<hr>

以下为变量类型为字符串的情况：

当声明一个变量的时候，`is_ref(bool)`**默认**被设置为`false`，他的作用是区分这个变量是否被引用，`refcount`是个计数器，有几个变量使用zval变量容器他就是几，这个值我理解的是有几个变量使用这个变量容器。

当refcount的值为0的时候，包含类型和值的这个变量容器就会从内存中删除。

每当unset()的时候计数器减1，直到为0从内存中消失。

<hr>

数组的情况，取决于是否有引用，正常情况不引用的和上面的一样，对应的变量名、类型、是否引用、指向zval变量个数。

但是当对数组有引用操作的时候情况就不同了。

``$a = array('one');
$a[] = &$a;
``
$a 自己指向自己，如果var_dump($a)会发现一个递归提示，就像来回踢皮球，来回来去的指，但是这里PHP内部应该主动停止了，不然来回指会花费更多的时间，但是当我打印的时候并没有发现时间很慢，而是马上出现结果的。这里只是猜测的，也许不够准确，我想了解更多的东西。


